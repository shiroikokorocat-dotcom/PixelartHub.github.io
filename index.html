<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Select a Character</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Silkscreen:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="fondo-mosaico"></div>
    <canvas id="nubes-canvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;"></canvas>
    <h1>Select a<br>Character</h1>
    <div id="canvas-container">
        <canvas id="pixelart-canvas"></canvas>
    </div>
    <div id="info-panel" class="hidden">
    <button id="panel-close" class="panel-close" type="button" aria-label="Cerrar">✕</button>
        <div class="info-content">
            <div class="info-left">
                <img id="segment-preview" alt="Vista previa" />
                <div id="palette" class="palette">
                    <div class="palette-title">Palette</div>
                    <div id="color-palette" class="palette-swatches"></div>
                </div>
            </div>
            <div class="divider" aria-hidden="true"><span class="divider-rot" aria-hidden="true"></span></div>
            <div class="info-right">
                <div class="header">
                    <h2 id="personaje-nombre"></h2>
                </div>
                <div class="profile">
                    <img id="pfp-image" alt="Perfil" />
                </div>
                <div class="divider-h" aria-hidden="true"></div>
                <div id="stats" class="stats">
                    <div class="stats-title">Stats:</div>
                </div>
                <div class="meta">
                    <div id="social-links">
                        <div class="social-row"><span class="site-label">X</span><a id="link-x" class="social hidden" href="#" target="_blank" rel="noopener"></a></div>
                        <div class="social-row"><span class="site-label">VG</span><a id="link-vgen" class="social hidden" href="#" target="_blank" rel="noopener"></a></div>
                        <div class="social-row"><span class="site-label">KF</span><a id="link-kofi" class="social hidden" href="#" target="_blank" rel="noopener"></a></div>
                        <div class="social-row"><span class="site-label">YT</span><a id="link-youtube" class="social hidden" href="#" target="_blank" rel="noopener"></a></div>
                        <div class="social-row"><span class="site-label">TTV</span><a id="link-twitch" class="social hidden" href="#" target="_blank" rel="noopener"></a></div>
                           <div class="social-row"><span class="site-label">BS</span><a id="link-bluesky" class="social hidden" href="#" target="_blank" rel="noopener"></a></div>
                        <div class="social-row"><span class="site-label">PF</span><a id="link-portfolio" class="social hidden" href="#" target="_blank" rel="noopener"></a></div>
                    </div>
                    <div id="preview-controls" class="dev-controls">
                        <div class="control-title">Preview size</div>
                        <div class="control-row">
                            <label for="slider-vh">Alt. máx (vh)</label>
                            <input type="range" id="slider-vh" min="10" max="80" step="1">
                            <span id="value-vh" class="control-val"></span>
                        </div>
                        <div class="control-row">
                            <label for="slider-vw">Anch. máx (vw)</label>
                            <input type="range" id="slider-vw" min="10" max="80" step="1">
                            <span id="value-vw" class="control-val"></span>
                        </div>
                    </div>
                </div>
                <img id="user-image" class="hidden" />
            </div>
        </div>
    </div>
    <script src="app.js"></script>
        <script>
        // Simple SFX manager using assets/ui/Sounds (with autoplay priming)
        (function(){
            const enabled = true;
            const VOLUME_MULT = 0.8; // reduce all volumes by 20%
            const sounds = {
                clickA: 'assets/ui/Sounds/click-a.ogg',
                clickB: 'assets/ui/Sounds/click-b.ogg',
                switchA: 'assets/ui/Sounds/switch-a.ogg',
                switchB: 'assets/ui/Sounds/switch-b.ogg',
                tapA: 'assets/ui/Sounds/tap-a.ogg',
                tapB: 'assets/ui/Sounds/tap-b.ogg'
            };
            const pool = new Map();
            let primed = false;

            async function primeOnce() {
                if (primed) return; // avoid re-priming
                primed = true;
                // Create at least one muted element per source and attempt muted autoplay
                const entries = Object.values(sounds);
                await Promise.all(entries.map(async (src) => {
                    try {
                        let list = pool.get(src);
                        if (!list) { list = []; pool.set(src, list); }
                        const a = new Audio(src);
                        a.preload = 'auto';
                        a.muted = true; // muted autoplay is allowed in most browsers
                        a.volume = 0;
                        a.loop = false;
                        a.playsInline = true;
                        // Attempt to play briefly, then pause and unmute for later use
                        await a.play().catch(() => {});
                        setTimeout(() => { try { a.pause(); a.currentTime = 0; a.muted = false; } catch {} }, 150);
                        list.push(a);
                    } catch {}
                }));
            }

            function ensureListFor(src) {
                let list = pool.get(src);
                if (!list) { list = []; pool.set(src, list); }
                return list;
            }

            function play(key, volume=0.35) {
                if (!enabled) return;
                const src = sounds[key];
                if (!src) return;
                const list = ensureListFor(src);
                let a = list.find(x => x.paused);
                if (!a) {
                    a = new Audio(src);
                    a.preload = 'auto';
                    a.playsInline = true;
                    list.push(a);
                }
                const v = Math.max(0, Math.min(1, volume * VOLUME_MULT));
                try {
                    a.currentTime = 0;
                    a.volume = v;
                    const p = a.play();
                    if (p && typeof p.then === 'function') {
                        p.catch(() => {
                            // If blocked, try priming again (idempotent)
                            primed = false;
                            primeOnce();
                        });
                    }
                } catch {
                    primed = false;
                    primeOnce();
                }
            }

            // Try to prime as early as possible
            try { primeOnce(); } catch {}
            // Retry on visibility or first pointer move (no click required)
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') primeOnce(); });
            const onFirstPointerMove = () => { primeOnce(); document.removeEventListener('pointermove', onFirstPointerMove); };
            document.addEventListener('pointermove', onFirstPointerMove, { once: true });

            window.SFX = { play, forcePrime: primeOnce };
        })();
    // PFP volador: al clickear la imagen de PFP del panel, lanza esa misma PFP en parábola L→R o R→L
    (function() {
        function currentPfpSrc() {
            const el = document.getElementById('pfp-image');
            if (!el) return null;
            const src = el.getAttribute('src') || '';
            // ignorar placeholder transparente u origen vacío
            if (!src || /^data:image\/gif/i.test(src)) return null;
            return src;
        }
        function pickPfpSrc() {
            try {
                // Priorizar el PFP actualmente mostrado en el panel
                const cur = currentPfpSrc();
                if (cur) return cur;
                const segs = Array.isArray(window.segmentos) ? window.segmentos : [];
                // Si hay selección/hover actual, priorizar su PFP
                if (Number.isInteger(window.currentIdx) && segs[window.currentIdx]) {
                    const v = segs[window.currentIdx].perfil;
                    if (v && v !== '-' && String(v).trim()) {
                        let p = String(v).replace(/\\\\/g,'/').replace(/^\/*/,'');
                        if (!/^https?:\/\//i.test(p) && !p.startsWith('assets/')) {
                            if (p.startsWith('pfp_web/')) p = 'assets/' + p;
                            else if (p.startsWith('pfp/')) p = 'assets/' + p;
                            else p = 'assets/pfp_web/' + p.split('/').pop();
                        }
                        return p;
                    }
                }
                // Fallback: cualquiera con PFP
                const candidates = segs.map(s => (s && s.perfil) ? String(s.perfil).replace(/\\\\/g,'/').replace(/^\/*/,'') : null)
                    .filter(v => v && v !== '-' && !/\s*$/.test(v));
                if (candidates.length === 0) return null;
                let pick = candidates[Math.floor(Math.random() * candidates.length)];
                if (!/^https?:\/\//i.test(pick) && !pick.startsWith('assets/')) {
                    if (pick.startsWith('pfp_web/')) pick = 'assets/' + pick;
                    else if (pick.startsWith('pfp/')) pick = 'assets/' + pick;
                    else pick = 'assets/pfp_web/' + pick.split('/').pop();
                }
                return pick;
            } catch { return null; }
        }
        function launchFlyer(fromLeft = Math.random() < 0.5) {
            const src = pickPfpSrc();
            if (!src) return;
            const img = document.createElement('img');
            img.className = 'pfp-flyer';
            // iniciar justo fuera de la pantalla por la izquierda o derecha
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const startX = fromLeft ? -100 : vw + 100;
            const endX = fromLeft ? vw + 120 : -120;
            // Rango vertical ampliado para mayor variedad de parábolas
            const startY = Math.floor(vh * (0.02 + Math.random() * 0.58)); // 2-60% altura
            const apexY = Math.floor(vh * (0.00 + Math.random() * 0.32));  // 0-32% (pico alto)
            const endY  = Math.floor(vh * (0.40 + Math.random() * 0.55));  // 40-95%
            const rotDir = fromLeft ? 1 : -1;
            const duration = 3200 + Math.floor(Math.random() * 1200); // 3.2s - 4.4s
            const startTime = performance.now();
            // Posición controlada únicamente por transform para evitar offset doble
            img.style.left = '0px';
            img.style.top = '0px';
            img.style.transform = `translate3d(${startX}px, ${startY}px, 0) rotate(0deg)`;

            // precarga para evitar flash roto
            const pre = new Image();
            pre.onload = () => {
                img.src = pre.src;
                document.body.appendChild(img);
                requestAnimationFrame(tick);
            };
            pre.onerror = () => {/* omitir si falla */};
            pre.src = src;

            function parabola(t) {
                // Interpolación paramétrica con un vértice (apex) y extremos (start, end)
                // Lerp X lineal, Y describe parábola con apex
                const x = startX + (endX - startX) * t;
                // Usar parábola a través de (0,startY), (0.5,apexY), (1,endY)
                // y(t) = a t^2 + b t + c, con c = startY
                const c = startY;
                const b = 4*apexY - endY - 3*startY;
                const a = endY - b - c;
                const y = a*t*t + b*t + c;
                return { x, y };
            }
            function tick(now) {
                const elapsed = now - startTime;
                const t = Math.min(1, elapsed / duration);
                const p = parabola(t);
                const rot = (t * 720 * rotDir); // 2 vueltas
                img.style.transform = `translate3d(${Math.round(p.x)}px, ${Math.round(p.y)}px, 0) rotate(${rot.toFixed(1)}deg)`;
                // remover si salió por completo
                if (t >= 1 || p.x < -160 || p.x > (vw + 160) || p.y < -160 || p.y > (vh + 160)) {
                    img.remove();
                    return;
                }
                requestAnimationFrame(tick);
            }
        }
        // esperar a que app.js cargue los segmentos globales
        function ready() {
            return Array.isArray(window.segmentos) && window.segmentos.length > 0;
        }
        // Trigger: click en la imagen de PFP del panel de información
        function bindTrigger() {
            const pfp = document.getElementById('pfp-image');
            if (!pfp) return;
            pfp.addEventListener('click', () => {
                // alternar dirección aleatoriamente
                window.SFX?.play('tapA', 0.35);
                launchFlyer(Math.random() < 0.5);
            });
        }
        if (ready()) bindTrigger();
        else {
            const id = setInterval(() => {
                if (ready()) { clearInterval(id); bindTrigger(); }
            }, 300);
        }
    })();
    // Close button + Esc support
    (function(){
        const btn = document.getElementById('panel-close');
        function closePanel(){
            // mimic clicking outside: unlock and hide (same path)
            document.dispatchEvent(new CustomEvent('ui:close-panel'));
        }
        if (btn) btn.addEventListener('click', closePanel);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePanel();
        });
    })();
    // Debug overlay for info panel divisions: enable with ?debug=1 or toggle via Ctrl/Alt + D
    (function(){
        const info = document.getElementById('info-panel');
        if (!info) return;
        const params = new URLSearchParams(window.location.search);
        const initial = params.get('debug');
        if (initial === '1' || initial === 'true') {
            info.classList.add('debug');
        }
        document.addEventListener('keydown', (e) => {
            if ((e.key === 'd' || e.key === 'D') && (e.ctrlKey || e.altKey)) {
                info.classList.toggle('debug');
                e.preventDefault();
            }
        });
    })();
    </script>
</body>
</html>
